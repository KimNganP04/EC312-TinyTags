<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ch·ªânh S·ª≠a B√†i Vi·∫øt - Tiny Tags</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="marketing.css">
    
    <!-- Additional CSS specific for edit post page -->
    <style>
        /* Custom styles */
        :root {
            --primary-red: #F3376D;
            --primary-dark: #90324D;
            --primary-beige: #FAEED6;
            --primary-yellow: #FADE98;
            --primary-pink-light: #FCE4E5;
            --primary-pink: #FF95A6;
        }
        
        .editor-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .editor-toolbar {
            background: #f8f9fa;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .editor-content {
            min-height: 300px;
            padding: 20px;
            outline: none;
        }
        
        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload-area:hover {
            border-color: var(--primary-red);
            background: var(--primary-pink-light);
        }
        
        .hashtag-input-container {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            padding: 12px;
        }
        
        .hashtag-input {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 40px;
        }
        
        .hashtag {
            background: #e0f2fe;
            color: #0369a1;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
        }
        
        .hashtag-remove {
            margin-left: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-primary-custom {
            background-color: var(--primary-red);
            color: white;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }
        
        .btn-primary-custom:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .btn-secondary-custom {
            background-color: white;
            color: var(--primary-dark);
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            border: 2px solid var(--primary-dark);
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .btn-secondary-custom:hover {
            background-color: var(--primary-dark);
            color: white;
        }
        
        .platform-tag {
            display: inline-block;
            padding: 6px 12px;
            background: #f3f4f6;
            border-radius: 20px;
            margin: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .platform-tag:hover {
            background: #e5e7eb;
        }
        
        .platform-tag.active {
            background: var(--primary-red) !important;
            color: white !important;
            border-color: var(--primary-red);
        }
        
        .image-preview {
            max-width: 200px;
            border-radius: 8px;
            margin: 8px;
        }
        
        .feedback-section {
            background: #f0f9ff;
            border-left: 4px solid #0369a1;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }
        
        .feedback-content {
            color: #0369a1;
            font-style: italic;
        }
        
        .toolbar-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1px solid #e5e7eb;
            cursor: pointer;
        }
        
        .toolbar-btn:hover {
            background: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Main Container -->
    <div class="min-h-screen flex" style="width: 100%;">
        
        <!-- Sidebar Container (will be loaded by JS) -->
        <div id="sidebar-container">
            <!-- Sidebar will be loaded here -->
        </div>
        
        <div class="main-content">
            <!-- MAIN CONTENT -->
            <div class="flex-1">
                <!-- Header -->
                <header class="bg-white border-b px-8 py-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold text-dark" id="page-title">Ch·ªânh S·ª≠a B√†i Vi·∫øt</h2>
                            <p class="text-gray-600" id="page-subtitle">ID: <span id="post-id-display">ƒêang t·∫£i...</span></p>
                        </div>
                        
                        <div class="flex items-center space-x-4">
                            <!-- User info -->
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-gradient-to-r from-red-500 to-pink-500 rounded-full flex items-center justify-center text-white font-bold">
                                    MS
                                </div>
                                <div>
                                    <p class="text-sm font-medium">Marketing Staff</p>
                                    <p class="text-xs text-gray-500">Nh√¢n vi√™n n·ªôi dung</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </header>
                
                <!-- Main Content -->
                <main class="p-8">
                    <!-- Action Buttons -->
                    <div class="flex justify-between items-center mb-8">
                        <div class="flex space-x-3">
                            <button onclick="saveChanges()" class="btn-primary-custom">
                                <i class="fas fa-save mr-2"></i>L∆∞u thay ƒë·ªïi
                            </button>
                            <button onclick="goBack()" class="btn-secondary-custom">
                                <i class="fas fa-arrow-left mr-2"></i>Quay l·∫°i danh s√°ch
                            </button>
                        </div>
                        
                        <div class="text-sm text-gray-600">
                            <i class="fas fa-info-circle mr-2"></i>
                            ƒêang ch·ªânh s·ª≠a b√†i vi·∫øt
                        </div>
                    </div>
                    
                    <!-- Feedback Section (from manager) -->
                    <div id="feedback-section" class="feedback-section hidden">
                        <h3 class="font-medium text-blue-700 mb-2">
                            <i class="fas fa-comment-alt mr-2"></i>Ph·∫£n h·ªìi t·ª´ qu·∫£n l√Ω
                        </h3>
                        <div id="feedback-content" class="feedback-content">
                            <!-- Feedback s·∫Ω ƒë∆∞·ª£c load t·ª´ d·ªØ li·ªáu -->
                        </div>
                        <div class="mt-2 text-sm text-blue-600">
                            <i class="fas fa-clock mr-1"></i>
                            <span id="feedback-date"></span>
                        </div>
                    </div>
                    
                    <!-- Content Area -->
                    <div class="space-y-6">
                        <!-- Title Input -->
                        <div class="editor-container">
                            <div class="p-6">
                                <label class="block text-sm font-medium text-dark mb-2">
                                    <i class="fas fa-heading mr-2"></i>Ti√™u ƒë·ªÅ b√†i vi·∫øt <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="postTitle" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                       placeholder="Nh·∫≠p ti√™u ƒë·ªÅ h·∫•p d·∫´n...">
                            </div>
                        </div>
                        
                        <!-- Content Editor -->
                        <div class="editor-container">
                            <div class="editor-toolbar">
                                <div class="toolbar-btn" title="In ƒë·∫≠m" onclick="formatText('bold')">
                                    <i class="fas fa-bold"></i>
                                </div>
                                <div class="toolbar-btn" title="In nghi√™ng" onclick="formatText('italic')">
                                    <i class="fas fa-italic"></i>
                                </div>
                                <div class="toolbar-btn" title="G·∫°ch ch√¢n" onclick="formatText('underline')">
                                    <i class="fas fa-underline"></i>
                                </div>
                                <div class="toolbar-btn" title="Danh s√°ch kh√¥ng th·ª© t·ª±" onclick="formatText('insertUnorderedList')">
                                    <i class="fas fa-list-ul"></i>
                                </div>
                                <div class="toolbar-btn" title="Danh s√°ch c√≥ th·ª© t·ª±" onclick="formatText('insertOrderedList')">
                                    <i class="fas fa-list-ol"></i>
                                </div>
                                <div class="toolbar-btn" title="Li√™n k·∫øt" onclick="insertLink()">
                                    <i class="fas fa-link"></i>
                                </div>
                                <div class="toolbar-btn" title="Th√™m ·∫£nh" onclick="insertImage()">
                                    <i class="fas fa-image"></i>
                                </div>
                                <div class="toolbar-btn" title="Emoji" onclick="insertEmoji()">
                                    <i class="fas fa-smile"></i>
                                </div>
                                <div class="flex-1"></div>
                                <div class="toolbar-btn" title="X√≥a ƒë·ªãnh d·∫°ng" onclick="formatText('removeFormat')">
                                    <i class="fas fa-eraser"></i>
                                </div>
                            </div>
                            
                            <div class="p-6">
                                <label class="block text-sm font-medium text-dark mb-2">
                                    <i class="fas fa-align-left mr-2"></i>N·ªôi dung b√†i vi·∫øt <span class="text-red-500">*</span>
                                </label>
                                <div class="editor-content border border-gray-300 rounded-lg" 
                                     contenteditable="true" 
                                     id="postContent"
                                     placeholder="Nh·∫≠p n·ªôi dung b√†i vi·∫øt c·ªßa b·∫°n ·ªü ƒë√¢y..."></div>
                                <div class="mt-2 text-xs text-gray-500 flex justify-between">
                                    <span id="charCount">0 k√Ω t·ª±</span>
                                    <span><i class="fas fa-lightbulb mr-1"></i>G·ª£i √Ω: S·ª≠ d·ª•ng emoji ƒë·ªÉ tƒÉng t∆∞∆°ng t√°c</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Category Selection -->
                        <div class="editor-container">
                            <div class="p-6">
                                <label class="block text-sm font-medium text-dark mb-2">
                                    <i class="fas fa-tag mr-2"></i>Danh m·ª•c
                                </label>
                                <select id="postCategory" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                    <option value="moc-khoa">M√≥c kh√≥a charm</option>
                                    <option value="day-deo">D√¢y ƒëeo ƒëi·ªán tho·∫°i charm</option>
                                    <option value="set-diy">Set DIY charm</option>
                                    <option value="vong-tay">V√≤ng tay charm</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Hashtags -->
                        <div class="editor-container">
                            <div class="p-6">
                                <label class="block text-sm font-medium text-dark mb-2">
                                    <i class="fas fa-hashtag mr-2"></i>Hashtags
                                </label>
                                <div class="hashtag-input-container">
                                    <div id="hashtagsContainer" class="hashtag-input mb-3">
                                        <!-- Hashtags s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                                    </div>
                                    <div class="flex">
                                        <input type="text" 
                                               id="hashtagInput" 
                                               class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                               placeholder="Th√™m hashtag (nh·∫•n Enter ho·∫∑c d·∫•u ph·∫©y)">
                                        <button onclick="addHashtag()" class="bg-gray-100 px-4 py-2 rounded-r-lg border border-l-0 border-gray-300 hover:bg-gray-200">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div class="mt-2 text-xs text-gray-500">
                                        <i class="fas fa-info-circle mr-1"></i>G·ª£i √Ω: #tinytags #phukiencharm #charmdethuong
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Image Upload -->
                        <div class="editor-container">
                            <div class="p-6">
                                <label class="block text-sm font-medium text-dark mb-2">
                                    <i class="fas fa-images mr-2"></i>H√¨nh ·∫£nh b√†i vi·∫øt
                                </label>
                                <div class="file-upload-area" onclick="document.getElementById('imageUpload').click()">
                                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                    <p class="text-gray-600 mb-2">K√©o th·∫£ ·∫£nh v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn</p>
                                    <p class="text-sm text-gray-500">H·ªó tr·ª£: JPG, PNG, GIF (t·ªëi ƒëa 5MB)</p>
                                </div>
                                <input type="file" 
                                       id="imageUpload" 
                                       class="hidden" 
                                       accept="image/*" 
                                       multiple
                                       onchange="handleImageUpload(event)">
                                
                                <!-- Image Preview -->
                                <div id="imagePreview" class="mt-4 flex flex-wrap">
                                    <!-- H√¨nh ·∫£nh s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Platform Selection -->
                        <div class="editor-container">
                            <div class="p-6">
                                <label class="block text-sm font-medium text-dark mb-2">
                                    <i class="fas fa-share-alt mr-2"></i>N·ªÅn t·∫£ng ƒëƒÉng b√†i
                                </label>
                                <div class="flex flex-wrap gap-2">
                                    <div class="platform-tag cursor-pointer" data-platform="facebook_page" onclick="togglePlatform(this)">
                                        <i class="fab fa-facebook mr-2"></i>Trang Facebook
                                    </div>
                                    
                                    <div class="platform-tag cursor-pointer" data-platform="facebook_group" onclick="togglePlatform(this)">
                                        <i class="fab fa-facebook mr-2"></i>Nh√≥m Facebook
                                    </div>
                                    
                                    <div class="platform-tag cursor-pointer" data-platform="tiktok" onclick="togglePlatform(this)">
                                        <i class="fab fa-tiktok mr-2"></i>TikTok
                                    </div>
                                </div>
                                <input type="hidden" id="selectedPlatforms" value="">
                                <div class="mt-2 text-xs text-gray-500">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    C√≥ th·ªÉ ch·ªçn nhi·ªÅu n·ªÅn t·∫£ng ƒë·ªÉ ƒëƒÉng b√†i
                                </div>
                            </div>
                        </div>
                        
                        <!-- Status Selection -->
                        <div class="editor-container">
                            <div class="p-6">
                                <label class="block text-sm font-medium text-dark mb-2">
                                    <i class="fas fa-flag mr-2"></i>Tr·∫°ng th√°i b√†i vi·∫øt
                                </label>
                                <select id="postStatus" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                    <option value="draft">B·∫£n nh√°p</option>
                                    <option value="pending">Ch·ªù duy·ªát</option>
                                    <option value="approved">ƒê√£ duy·ªát</option>
                                    <option value="published">ƒê√£ ƒëƒÉng</option>
                                </select>
                                <div class="mt-2 text-xs text-gray-500">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Ch·ªçn "Ch·ªù duy·ªát" ƒë·ªÉ g·ª≠i b√†i vi·∫øt cho qu·∫£n l√Ω ph√™ duy·ªát
                                </div>
                            </div>
                        </div>
                        
                        <!-- Save Buttons -->
                        <div class="flex justify-end space-x-4">
                            <button onclick="saveAsDraft()" class="btn-secondary-custom">
                                <i class="fas fa-file-alt mr-2"></i>L∆∞u nh√°p
                            </button>
                            <button onclick="submitForReview()" class="btn-primary-custom bg-blue-600 hover:bg-blue-700">
                                <i class="fas fa-paper-plane mr-2"></i>G·ª≠i duy·ªát
                            </button>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script src="marketing.js"></script>
    
    <!-- JavaScript for Edit Post Page -->
    <script>
        // Global variables
        let currentPostId = null;
        let originalPost = null;
        let hashtags = [];
        let images = [];
        let selectedPlatforms = [];
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Get post ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            currentPostId = urlParams.get('id');
            
            if (!currentPostId) {
                alert('Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt!');
                window.location.href = 'danhsachbaiviet.html';
                return;
            }
            
            // Load post data
            loadPostData(currentPostId);
            
            // Setup editor and event listeners
            setupEditor();
            setupEventListeners();
        });
        
        // Load post data
        function loadPostData(postId) {
            const post = getPostById(postId);
            
            if (!post) {
                alert('B√†i vi·∫øt kh√¥ng t·ªìn t·∫°i!');
                window.location.href = 'danhsachbaiviet.html';
                return;
            }
            
            originalPost = post;
            
            // Update UI with post data
            updateUIWithPostData(post);
            
            // Load feedback if exists
            if (post.feedback) {
                document.getElementById('feedback-section').classList.remove('hidden');
                document.getElementById('feedback-content').textContent = post.feedback;
                if (post.feedbackDate) {
                    document.getElementById('feedback-date').textContent = `Ng√†y: ${formatDate(post.feedbackDate)}`;
                }
            }
            
            console.log('‚úÖ ƒê√£ load b√†i vi·∫øt th√†nh c√¥ng:', post);
        }
        
        // Update UI with post data - HO√ÄN CH·ªàNH
        function updateUIWithPostData(post) {
            console.log('üîÑ ƒêang load d·ªØ li·ªáu b√†i vi·∫øt:', {
                id: post.id,
                title: post.title,
                hashtags: post.hashtags,
                images: post.images,
                platforms: post.platforms,
                rawPost: post
            });
            
            // Basic info
            document.getElementById('post-id-display').textContent = post.id;
            document.getElementById('page-title').textContent = `Ch·ªânh S·ª≠a: ${post.title || 'B√†i vi·∫øt kh√¥ng c√≥ ti√™u ƒë·ªÅ'}`;
            document.getElementById('postTitle').value = post.title || '';
            
            // Content
            const contentElement = document.getElementById('postContent');
            if (post.content && post.content.trim() !== '') {
                contentElement.innerHTML = post.content;
            } else if (post.description) {
                contentElement.innerHTML = `<p>${post.description}</p>`;
            } else {
                contentElement.innerHTML = '<p>Nh·∫≠p n·ªôi dung b√†i vi·∫øt ·ªü ƒë√¢y...</p>';
            }
            
            // Category
            if (post.category) {
                document.getElementById('postCategory').value = post.category;
            }
            
            // Status
            if (post.status) {
                document.getElementById('postStatus').value = post.status;
            }
            
            // Hashtags - X·ª¨ L√ù HO√ÄN CH·ªàNH
            hashtags = [];
            if (post.hashtags && Array.isArray(post.hashtags)) {
                hashtags = [...post.hashtags];
            } else if (post.tags && Array.isArray(post.tags)) {
                hashtags = [...post.tags];
            }
            updateHashtagsDisplay();
            
            // Images - X·ª¨ L√ù HO√ÄN CH·ªàNH
            images = [];
            if (post.images && Array.isArray(post.images)) {
                post.images.forEach((img, index) => {
                    if (typeof img === 'string' && img.trim() !== '') {
                        images.push({
                            name: `H√¨nh ${index + 1}`,
                            url: img,
                            file: null
                        });
                    } else if (typeof img === 'object' && img.url) {
                        images.push({
                            name: img.name || `H√¨nh ${index + 1}`,
                            url: img.url,
                            file: null
                        });
                    }
                });
            } else if (post.imageUrl && typeof post.imageUrl === 'string' && post.imageUrl.trim() !== '') {
                images.push({
                    name: 'H√¨nh ch√≠nh',
                    url: post.imageUrl,
                    file: null
                });
            } else if (post.photo && typeof post.photo === 'string' && post.photo.trim() !== '') {
                images.push({
                    name: 'H√¨nh ·∫£nh',
                    url: post.photo,
                    file: null
                });
            }
            updateImagesDisplay();
            
            // Platforms - X·ª¨ L√ù HO√ÄN CH·ªàNH
            selectedPlatforms = [];
            if (post.platforms && Array.isArray(post.platforms)) {
                selectedPlatforms = [...post.platforms];
                
                // X·ª≠ l√Ω ƒë·∫∑c bi·ªát: N·∫øu c√≥ 'facebook' generic, chuy·ªÉn th√†nh c·∫£ 2 lo·∫°i
                if (selectedPlatforms.includes('facebook')) {
                    if (!selectedPlatforms.includes('facebook_page')) {
                        selectedPlatforms.push('facebook_page');
                    }
                    if (!selectedPlatforms.includes('facebook_group')) {
                        selectedPlatforms.push('facebook_group');
                    }
                    // Lo·∫°i b·ªè 'facebook' generic
                    selectedPlatforms = selectedPlatforms.filter(p => p !== 'facebook');
                }
                
                // ƒê·∫£m b·∫£o kh√¥ng tr√πng
                selectedPlatforms = [...new Set(selectedPlatforms)];
            } else if (post.platform && typeof post.platform === 'string') {
                // X·ª≠ l√Ω ƒë∆°n l·∫ª
                if (post.platform === 'facebook') {
                    selectedPlatforms = ['facebook_page', 'facebook_group'];
                } else {
                    selectedPlatforms = [post.platform];
                }
            } else {
                // M·∫∑c ƒë·ªãnh ch·ªçn c·∫£ 2 Facebook
                selectedPlatforms = ['facebook_page', 'facebook_group'];
            }
            updatePlatformsDisplay();
            
            // Feedback section (n·∫øu c√≥)
            if (post.feedback && post.feedback.trim() !== '') {
                document.getElementById('feedback-section').classList.remove('hidden');
                document.getElementById('feedback-content').textContent = post.feedback;
                if (post.feedbackDate) {
                    document.getElementById('feedback-date').textContent = `Ng√†y: ${formatDate(post.feedbackDate)}`;
                }
            }
            
            // Update character count
            updateCharCount();
            
            console.log('‚úÖ ƒê√£ load xong:', { 
                hashtags, 
                images, 
                selectedPlatforms 
            });
        }
        
        // Setup editor
        function setupEditor() {
            const editor = document.getElementById('postContent');
            
            editor.addEventListener('input', function() {
                updateCharCount();
            });
            
            // Hashtag input
            const hashtagInput = document.getElementById('hashtagInput');
            hashtagInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    addHashtag();
                }
            });
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Enter to add hashtag
            document.getElementById('hashtagInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addHashtag();
                }
            });
            
            // Load existing images and platforms when page loads
            window.addEventListener('load', function() {
                if (originalPost) {
                    console.log('Initial load with post:', originalPost);
                }
            });
        }
        
        // Editor functions
        function formatText(command) {
            document.execCommand(command, false, null);
        }
        
        function insertLink() {
            const url = prompt('Nh·∫≠p URL li√™n k·∫øt:', 'https://');
            if (url) {
                document.execCommand('createLink', false, url);
            }
        }
        
        function insertImage() {
            const url = prompt('Nh·∫≠p URL h√¨nh ·∫£nh:', 'https://images.unsplash.com/photo-');
            if (url) {
                // Th√™m v√†o images array
                images.push({
                    name: 'H√¨nh t·ª´ URL',
                    url: url,
                    file: null
                });
                updateImagesDisplay();
                
                // Th√™m v√†o editor
                const img = document.createElement('img');
                img.src = url;
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                img.style.margin = '10px 0';
                document.execCommand('insertHTML', false, img.outerHTML);
            }
        }
        
        function insertEmoji() {
            const emojis = ['üòÄ', 'üòç', 'üéâ', 'üî•', '‚ù§Ô∏è', '‚ú®', 'üëç', 'üëè', 'üíØ', 'üåü', 'üõçÔ∏è', 'üíé', 'üéÄ', 'ü¶Ñ', 'üå∏'];
            const emojiList = emojis.join(' ');
            const emoji = prompt(`Nh·∫≠p emoji ho·∫∑c ch·ªçn t·ª´ danh s√°ch:\n${emojiList}\n\nG·ª£i √Ω cho charm: üéÄ ü¶Ñ üíé üõçÔ∏è`);
            if (emoji) {
                document.execCommand('insertText', false, emoji);
            }
        }
        
        // Update character count
        function updateCharCount() {
            const editor = document.getElementById('postContent');
            const charLength = editor.textContent.length;
            document.getElementById('charCount').textContent = `${charLength} k√Ω t·ª±`;
        }
        
        // Hashtag functions
        function addHashtag() {
            const input = document.getElementById('hashtagInput');
            let tag = input.value.trim();
            
            if (!tag) return;
            
            // Remove # if user typed it
            if (tag.startsWith('#')) {
                tag = tag.substring(1);
            }
            
            // Remove spaces and special characters
            tag = tag.replace(/\s+/g, '').toLowerCase();
            
            if (tag && !hashtags.includes(tag) && tag.length > 0) {
                hashtags.push(tag);
                updateHashtagsDisplay();
                input.value = '';
            }
        }
        
        function removeHashtag(tag) {
            hashtags = hashtags.filter(t => t !== tag);
            updateHashtagsDisplay();
        }
        
        function updateHashtagsDisplay() {
            const container = document.getElementById('hashtagsContainer');
            container.innerHTML = '';
            
            if (hashtags.length === 0) {
                container.innerHTML = '<div class="text-gray-400 italic text-sm">Ch∆∞a c√≥ hashtag n√†o</div>';
                return;
            }
            
            hashtags.forEach(tag => {
                const tagElement = document.createElement('div');
                tagElement.className = 'hashtag';
                tagElement.innerHTML = `
                    #${tag}
                    <span class="hashtag-remove" onclick="removeHashtag('${tag}')">
                        <i class="fas fa-times"></i>
                    </span>
                `;
                container.appendChild(tagElement);
            });
        }
        
        // Image functions
        function handleImageUpload(event) {
            const files = event.target.files;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert(`File ${file.name} v∆∞·ª£t qu√° 5MB`);
                    continue;
                }
                
                // Check file type
                if (!file.type.startsWith('image/')) {
                    alert(`File ${file.name} kh√¥ng ph·∫£i l√† h√¨nh ·∫£nh`);
                    continue;
                }
                
                // Create preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    images.push({
                        name: file.name,
                        url: e.target.result,
                        file: file
                    });
                    updateImagesDisplay();
                };
                reader.readAsDataURL(file);
            }
            
            // Reset input
            event.target.value = '';
        }
        
        function removeImage(index) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h√¨nh ·∫£nh n√†y?')) {
                images.splice(index, 1);
                updateImagesDisplay();
            }
        }
        
        function updateImagesDisplay() {
            const container = document.getElementById('imagePreview');
            container.innerHTML = '';
            
            if (images.length === 0) {
                container.innerHTML = '<p class="text-gray-500 italic">Ch∆∞a c√≥ h√¨nh ·∫£nh n√†o</p>';
                return;
            }
            
            images.forEach((image, index) => {
                const imgContainer = document.createElement('div');
                imgContainer.className = 'relative inline-block m-2';
                
                // Hi·ªÉn th·ªã h√¨nh ·∫£nh
                const imgElement = document.createElement('img');
                imgElement.src = image.url;
                imgElement.alt = image.name;
                imgElement.className = 'image-preview';
                
                // N√∫t x√≥a
                const deleteButton = document.createElement('div');
                deleteButton.className = 'absolute top-0 right-0 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center cursor-pointer transform translate-x-1 -translate-y-1';
                deleteButton.innerHTML = '<i class="fas fa-times text-xs"></i>';
                deleteButton.onclick = () => removeImage(index);
                
                // T√™n file
                const fileName = document.createElement('p');
                fileName.className = 'text-xs text-gray-600 text-center mt-1';
                fileName.textContent = image.name.length > 15 ? image.name.substring(0, 15) + '...' : image.name;
                
                imgContainer.appendChild(imgElement);
                imgContainer.appendChild(deleteButton);
                imgContainer.appendChild(fileName);
                
                container.appendChild(imgContainer);
            });
        }
        
        // Platform functions
        function togglePlatform(element) {
            const platform = element.getAttribute('data-platform');
            
            if (selectedPlatforms.includes(platform)) {
                selectedPlatforms = selectedPlatforms.filter(p => p !== platform);
                element.classList.remove('active');
                element.style.backgroundColor = '#f3f4f6';
                element.style.color = '#374151';
            } else {
                selectedPlatforms.push(platform);
                element.classList.add('active');
                element.style.backgroundColor = '#F3376D';
                element.style.color = 'white';
            }
            
            document.getElementById('selectedPlatforms').value = selectedPlatforms.join(',');
            console.log('Selected platforms:', selectedPlatforms);
        }
        
        function updatePlatformsDisplay() {
            // Reset all platforms
            document.querySelectorAll('.platform-tag').forEach(tag => {
                tag.classList.remove('active');
                tag.style.backgroundColor = '#f3f4f6';
                tag.style.color = '#374151';
            });
            
            // Activate selected platforms
            selectedPlatforms.forEach(platform => {
                const tag = document.querySelector(`.platform-tag[data-platform="${platform}"]`);
                if (tag) {
                    tag.classList.add('active');
                    tag.style.backgroundColor = '#F3376D';
                    tag.style.color = 'white';
                }
            });
            
            document.getElementById('selectedPlatforms').value = selectedPlatforms.join(',');
        }
        
        // Format date
        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return dateString;
                }
                return date.toLocaleDateString('vi-VN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (e) {
                return dateString;
            }
        }
        
        // Save functions
        function saveChanges(status = 'draft') {
            const postData = collectFormData();
            
            if (!validateForm(postData)) {
                return;
            }
            
            postData.status = status;
            postData.updatedAt = new Date().toISOString();
            
            // Th√™m ng√†y publish n·∫øu l√† published
            if (status === 'published' && !postData.publishDate) {
                postData.publishDate = new Date().toLocaleDateString('vi-VN');
            }
            
            console.log('üíæ Saving post data:', postData);
            
            // Update post in storage
            updatePostInStorage(postData);
            
            // Show success message
            let message = '';
            if (status === 'draft') {
                message = 'B√†i vi·∫øt ƒë√£ ƒë∆∞·ª£c l∆∞u nh√°p th√†nh c√¥ng!';
            } else if (status === 'pending') {
                message = 'B√†i vi·∫øt ƒë√£ ƒë∆∞·ª£c g·ª≠i duy·ªát th√†nh c√¥ng!';
            } else {
                message = 'B√†i vi·∫øt ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!';
            }
            
            alert(message);
            
            // Redirect back to posts list
            setTimeout(() => {
                window.location.href = 'danhsachbaiviet.html?fromCreate=true&status=' + status;
            }, 500);
        }
        
        function saveAsDraft() {
            if (confirm('L∆∞u b√†i vi·∫øt d∆∞·ªõi d·∫°ng b·∫£n nh√°p?')) {
                saveChanges('draft');
            }
        }
        
        function submitForReview() {
            if (confirm('G·ª≠i b√†i vi·∫øt ƒë·ªÉ qu·∫£n l√Ω ph√™ duy·ªát?\n\nB√†i vi·∫øt s·∫Ω ƒë∆∞·ª£c chuy·ªÉn sang tr·∫°ng th√°i "Ch·ªù duy·ªát" v√† g·ª≠i ƒë·∫øn qu·∫£n l√Ω.')) {
                saveChanges('pending');
            }
        }
        
        // Collect form data
        function collectFormData() {
            const title = document.getElementById('postTitle').value.trim();
            const content = document.getElementById('postContent').innerHTML;
            const category = document.getElementById('postCategory').value;
            const status = document.getElementById('postStatus').value;
            
            // T·∫°o m√¥ t·∫£ ng·∫Øn t·ª´ n·ªôi dung
            const plainText = content.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
            const shortDescription = plainText.length > 150 ? plainText.substring(0, 147) + '...' : plainText;
            
            // Ch·ªâ l·∫•y URL t·ª´ images
            const imageUrls = images.map(img => img.url);
            
            // X·ª≠ l√Ω platforms ƒë·ªÉ l∆∞u
            let platformsToSave = [...selectedPlatforms];
            
            // N·∫øu c√≥ c·∫£ 2 lo·∫°i Facebook, th√™m 'facebook' generic
            const hasFacebookPage = platformsToSave.includes('facebook_page');
            const hasFacebookGroup = platformsToSave.includes('facebook_group');
            
            if (hasFacebookPage || hasFacebookGroup) {
                platformsToSave.push('facebook');
            }
            
            // ƒê·∫£m b·∫£o kh√¥ng tr√πng
            platformsToSave = [...new Set(platformsToSave)];
            
            return {
                id: parseInt(currentPostId),
                title: title,
                content: content,
                description: shortDescription || 'B√†i vi·∫øt v·ªÅ ph·ª• ki·ªán charm',
                category: category,
                status: status,
                hashtags: hashtags,
                images: imageUrls,
                platforms: platformsToSave,
                writeDate: originalPost.writeDate || new Date().toLocaleDateString('vi-VN'),
                publishDate: status === 'published' ? (originalPost.publishDate || new Date().toLocaleDateString('vi-VN')) : '',
                feedback: originalPost.feedback || '',
                feedbackDate: originalPost.feedbackDate || '',
                createdAt: originalPost.createdAt || new Date().toISOString()
            };
        }
        
        // Validate form
        function validateForm(postData) {
            if (!postData.title.trim()) {
                alert('Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ b√†i vi·∫øt');
                document.getElementById('postTitle').focus();
                return false;
            }
            
            const plainContent = postData.content.replace(/<[^>]*>/g, '').trim();
            if (!plainContent || plainContent === '') {
                alert('Vui l√≤ng nh·∫≠p n·ªôi dung b√†i vi·∫øt');
                document.getElementById('postContent').focus();
                return false;
            }
            
            // Ki·ªÉm tra hashtags (c√≥ th·ªÉ kh√¥ng c√≥)
            if (hashtags.length === 0) {
                if (!confirm('B√†i vi·∫øt ch∆∞a c√≥ hashtag n√†o. B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c kh√¥ng?')) {
                    document.getElementById('hashtagInput').focus();
                    return false;
                }
            }
            
            // Ki·ªÉm tra platforms (t·ªëi thi·ªÉu 1 n·ªÅn t·∫£ng)
            if (selectedPlatforms.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt n·ªÅn t·∫£ng ƒëƒÉng b√†i');
                return false;
            }
            
            return true;
        }
        
        // Go back
        function goBack() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën quay l·∫°i? C√°c thay ƒë·ªïi ch∆∞a l∆∞u s·∫Ω b·ªã m·∫•t.')) {
                window.location.href = 'danhsachbaiviet.html';
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                event.preventDefault();
                saveAsDraft();
            }
        });
    </script>
</body>
</html>