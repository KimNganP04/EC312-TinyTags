<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh S√°ch B√†i Vi·∫øt - Tiny Tags</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="marketing.css">
</head>
<body>
    <!-- Sidebar will be loaded here -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Page Header -->
        <div class="page-header">
            <div>
                <h1 class="page-title">Danh S√°ch B√†i Vi·∫øt</h1>
                <p class="page-subtitle">Qu·∫£n l√Ω t·∫•t c·∫£ b√†i vi·∫øt cho c·ª≠a h√†ng ph·ª• ki·ªán charm</p>
            </div>
            <a href="taobaiviet.html" class="btn-primary">
                <i class="fas fa-plus"></i>
                <span>T·∫°o b√†i vi·∫øt m·ªõi</span>
            </a>
        </div>
        
        <!-- Stats Overview - TH√äM TR·∫†NG TH√ÅI "T·ª™ CH·ªêI/C·∫¶N S·ª¨A" -->
        <div class="stats-overview">
            <div class="stat-card active" id="stat-all" data-status="all">
                <div class="stat-icon status-all">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="stat-info">
                    <h3 id="total-posts">0</h3>
                    <p>T·ªïng b√†i vi·∫øt</p>
                </div>
            </div>
            
            <div class="stat-card" id="stat-draft" data-status="draft">
                <div class="stat-icon status-draft-badge">
                    <i class="fas fa-edit"></i>
                </div>
                <div class="stat-info">
                    <h3 id="draft-posts">0</h3>
                    <p>B·∫£n nh√°p</p>
                </div>
            </div>
            
            <div class="stat-card" id="stat-pending" data-status="pending">
                <div class="stat-icon status-pending-badge">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-info">
                    <h3 id="pending-posts">0</h3>
                    <p>ƒêang ch·ªù duy·ªát</p>
                </div>
            </div>
            
            <div class="stat-card" id="stat-approved" data-status="approved">
                <div class="stat-icon status-approved-badge">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                    <h3 id="approved-posts">0</h3>
                    <p>ƒê√£ duy·ªát</p>
                </div>
            </div>
            
            <div class="stat-card" id="stat-published" data-status="published">
                <div class="stat-icon status-published-badge">
                    <i class="fas fa-share-square"></i>
                </div>
                <div class="stat-info">
                    <h3 id="published-posts">0</h3>
                    <p>ƒê√£ ƒëƒÉng</p>
                </div>
            </div>
            
            <!-- TH√äM TR·∫†NG TH√ÅI M·ªöI: T·ª™ CH·ªêI/C·∫¶N S·ª¨A -->
            <div class="stat-card" id="stat-rejected" data-status="rejected">
                <div class="stat-icon status-rejected-badge">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="stat-info">
                    <h3 id="rejected-posts">0</h3>
                    <p>C·∫ßn s·ª≠a</p>
                </div>
            </div>
        </div>
        
        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-group">
                <select class="filter-select" id="category-filter">
                    <option value="all">T·∫•t c·∫£ danh m·ª•c</option>
                    <option value="moc-khoa">M√≥c kh√≥a charm</option>
                    <option value="day-deo">D√¢y ƒëeo ƒëi·ªán tho·∫°i charm</option>
                    <option value="set-diy">Set DIY charm</option>
                    <option value="vong-tay">V√≤ng tay charm</option>
                </select>
                
                <input type="text" class="search-box" id="search-box" placeholder="T√¨m ki·∫øm b√†i vi·∫øt theo ti√™u ƒë·ªÅ...">
            </div>
            
            <div class="filter-group">
                <button class="btn-secondary" id="reset-filters">
                    <i class="fas fa-redo"></i>
                    <span>ƒê·∫∑t l·∫°i</span>
                </button>
            </div>
        </div>
        
        <!-- Posts Table -->
        <div class="posts-table">
            <!-- Table Header - TH√äM C·ªòT "NG∆Ø·ªúI G·ª¨I" -->
            <div class="table-header">
                <div>Ti√™u ƒë·ªÅ b√†i vi·∫øt</div>
                <div>Ng∆∞·ªùi g·ª≠i</div>
                <div>Ng√†y vi·∫øt</div>
                <div>Ng√†y ƒëƒÉng</div>
                <div>Danh m·ª•c</div>
                <div>Tr·∫°ng th√°i</div>
                <div>Thao t√°c</div>
            </div>
            
            <!-- Table Rows will be populated by JavaScript -->
            <div id="posts-container"></div>
        </div>
        
        <!-- Pagination -->
        <div class="pagination">
            <button class="page-btn" id="prev-page">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="page-btn active">1</button>
            <button class="page-btn">2</button>
            <button class="page-btn">3</button>
            <button class="page-btn" id="next-page">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal" id="delete-modal">
        <div class="modal-content">
            <h3 class="modal-title">X√°c nh·∫≠n x√≥a</h3>
            <p class="modal-text">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i vi·∫øt "<span id="post-title-to-delete"></span>"? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
            <div class="modal-buttons">
                <button class="btn-secondary" id="cancel-delete">H·ªßy b·ªè</button>
                <button class="btn-primary" id="confirm-delete">X√≥a b√†i vi·∫øt</button>
            </div>
        </div>
    </div>
    
    <script>
        // ===== H·ªÜ TH·ªêNG C·∫¨P NH·∫¨T REAL-TIME =====
        let isInitialized = false;
        let refreshInterval;
        
        // H√†m kh·ªüi t·∫°o trang
        function initializePage() {
            console.log('üöÄ Kh·ªüi t·∫°o trang danhsachbaiviet.html');
            
            // Kh·ªüi t·∫°o sidebar
            if (typeof initSidebar === 'function') {
                setTimeout(initSidebar, 100);
            }
            
            // Kh·ªüi t·∫°o danh s√°ch b√†i vi·∫øt
            if (typeof initPostsPage === 'function') {
                initPostsPage();
            } else {
                // Fallback n·∫øu h√†m kh√¥ng t·ªìn t·∫°i
                console.log('‚ö†Ô∏è initPostsPage kh√¥ng t·ªìn t·∫°i, load marketing.js...');
                loadMarketingScript();
            }
            
            // Thi·∫øt l·∫≠p event listeners
            setupPageEventListeners();
            
            // B·∫Øt ƒë·∫ßu auto-refresh
            startAutoRefresh();
            
            isInitialized = true;
        }
        
        // Load marketing.js n·∫øu ch∆∞a c√≥
        function loadMarketingScript() {
            const script = document.createElement('script');
            script.src = 'marketing.js';
            script.onload = function() {
                console.log('‚úÖ ƒê√£ load marketing.js');
                setTimeout(() => {
                    if (typeof initPostsPage === 'function') {
                        initPostsPage();
                    }
                }, 500);
            };
            document.head.appendChild(script);
        }
        
        // H√†m refresh d·ªØ li·ªáu
        function refreshPostsData() {
            console.log('üîÑ ƒêang refresh d·ªØ li·ªáu...');
            
            // C·∫≠p nh·∫≠t th·ªëng k√™
            if (typeof updateStats === 'function') {
                updateStats();
            }
            
            // Render l·∫°i danh s√°ch
            if (typeof renderPosts === 'function') {
                renderPosts();
            }
        }
        
        // H√†m refresh v·ªõi hi·ªáu ·ª©ng
        function refreshWithAnimation() {
            const container = document.getElementById('posts-container');
            if (container) {
                // Th√™m hi·ªáu ·ª©ng loading
                container.style.opacity = '0.5';
                container.style.transition = 'opacity 0.3s';
                
                setTimeout(() => {
                    refreshPostsData();
                    
                    // Kh√¥i ph·ª•c opacity
                    setTimeout(() => {
                        container.style.opacity = '1';
                    }, 300);
                }, 300);
            } else {
                refreshPostsData();
            }
        }
        
        // B·∫Øt ƒë·∫ßu auto-refresh
        function startAutoRefresh() {
            // D·ª´ng interval c≈© n·∫øu c√≥
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            // T·∫°o interval m·ªõi (10 gi√¢y)
            refreshInterval = setInterval(() => {
                console.log('‚è∞ T·ª± ƒë·ªông refresh d·ªØ li·ªáu');
                refreshPostsData();
            }, 10000);
        }
        
        // Thi·∫øt l·∫≠p event listeners cho trang
        function setupPageEventListeners() {
            // L·∫Øng nghe storage events
            window.addEventListener('storage', handleStorageEvent);
            
            // L·∫Øng nghe custom events
            window.addEventListener('storageUpdated', handleStorageUpdated);
            window.addEventListener('postStatusChanged', handlePostStatusChanged);
            
            // L·∫Øng nghe khi trang ƒë∆∞·ª£c hi·ªÉn th·ªã l·∫°i
            window.addEventListener('pageshow', handlePageShow);
            
            // L·∫Øng nghe khi tab ƒë∆∞·ª£c focus
            window.addEventListener('focus', handleTabFocus);
            
            // Th√™m n√∫t refresh manual
            addRefreshButton();
        }
        
        // X·ª≠ l√Ω storage event
        function handleStorageEvent(e) {
            if (e.key === 'tiny_tags_posts' || e.key === null) {
                console.log('üì¶ Storage changed, refreshing...');
                setTimeout(refreshWithAnimation, 300);
            }
        }
        
        // X·ª≠ l√Ω custom event
        function handleStorageUpdated() {
            console.log('üì° Nh·∫≠n storageUpdated event');
            setTimeout(refreshWithAnimation, 200);
        }
        
        // X·ª≠ l√Ω post status changed event
        function handlePostStatusChanged(e) {
            console.log('üìù B√†i vi·∫øt thay ƒë·ªïi tr·∫°ng th√°i:', e.detail);
            setTimeout(refreshWithAnimation, 300);
        }
        
        // X·ª≠ l√Ω khi trang ƒë∆∞·ª£c hi·ªÉn th·ªã l·∫°i
        function handlePageShow(e) {
            if (e.persisted) {
                console.log('üîô Trang ƒë∆∞·ª£c restore t·ª´ cache');
                setTimeout(refreshWithAnimation, 500);
            }
        }
        
        // X·ª≠ l√Ω khi tab ƒë∆∞·ª£c focus
        function handleTabFocus() {
            console.log('üéØ Tab ƒë∆∞·ª£c focus, refreshing...');
            setTimeout(refreshPostsData, 300);
        }
        
        // Th√™m n√∫t refresh manual
        function addRefreshButton() {
            const pageHeader = document.querySelector('.page-header');
            if (pageHeader) {
                const refreshBtn = document.createElement('button');
                refreshBtn.className = 'btn-secondary';
                refreshBtn.style.marginLeft = '10px';
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i><span>Refresh</span>';
                refreshBtn.onclick = function(e) {
                    e.preventDefault();
                    refreshWithAnimation();
                    // Hi·ªÉn th·ªã th√¥ng b√°o
                    showToast('ƒêang l√†m m·ªõi d·ªØ li·ªáu...', 'info');
                };
                
                pageHeader.querySelector('.btn-primary').parentNode.appendChild(refreshBtn);
            }
        }
        
        // Hi·ªÉn th·ªã toast message
        function showToast(message, type = 'info') {
            // X√≥a toast c≈©
            const oldToast = document.querySelector('.toast-message');
            if (oldToast) oldToast.remove();
            
            // T·∫°o toast m·ªõi
            const toast = document.createElement('div');
            toast.className = `toast-message toast-${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            // Style cho toast
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10B981' : type === 'error' ? '#EF4444' : '#3B82F6'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                display: flex;
                align-items: center;
                gap: 10px;
                z-index: 9999;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(toast);
            
            // T·ª± ƒë·ªông x√≥a sau 3 gi√¢y
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
            
            // Th√™m CSS animation
            if (!document.querySelector('#toast-styles')) {
                const style = document.createElement('style');
                style.id = 'toast-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        // ƒê√°nh d·∫•u khi ƒëi ƒë·∫øn trang chi ti·∫øt
        window.navigateToDetail = function(postId) {
            sessionStorage.setItem('lastViewedPost', postId);
            sessionStorage.setItem('fromListPage', 'true');
            return true;
        };
        
        // Kh·ªüi t·∫°o khi DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM ready, ƒëang kh·ªüi t·∫°o...');
            
            // Ki·ªÉm tra n·∫øu v·ª´a quay l·∫°i t·ª´ trang chi ti·∫øt
            const fromDetail = sessionStorage.getItem('fromDetailPage');
            if (fromDetail) {
                console.log('üîô V·ª´a quay l·∫°i t·ª´ trang chi ti·∫øt');
                sessionStorage.removeItem('fromDetailPage');
                setTimeout(initializePage, 300);
            } else {
                initializePage();
            }
            
            // Ki·ªÉm tra URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('refreshed') === 'true') {
                console.log('üîÑ Ph√°t hi·ªán tham s·ªë refreshed');
                setTimeout(refreshWithAnimation, 500);
                // X√≥a tham s·ªë
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });
        
        // Cleanup khi trang unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
        
        // G·ªçi global functions
        window.refreshPostsData = refreshPostsData;
        window.refreshWithAnimation = refreshWithAnimation;
        window.showToast = showToast;
    </script>
    
    <script src="marketing.js"></script>
</body>
</html>